---
name: stm32-build-helper
description: Помощь в сборке проекта, интерпретация ошибок CMake/GCC и отладка проблем конфигурации, специфичных для фреймворка stm32-cmake-yml.
license: MIT
allowed-tools: Bash
---

# Помощник по сборке и диагностике STM32

Этот навык помогает решать типовые проблемы конфигурации и сборки в окружении `stm32-cmake-yml`.

## Процесс сборки

Для сборки проекта:
1.  **Конфигурация:** `cmake -S . -B build -G Ninja` (или доверьте это VS Code / CMake Tools).
    *   *Примечание:* При изменении `stm32_config.yml` конфигурация обычно запускается автоматически (через file watchers), но ручной перезапуск надежнее.
2.  **Сборка:** `cmake --build build`

## Частые ошибки и решения

### 1. "Linker script RAM size mismatch" / "HardFault при старте"
*   **Симптом:** Ошибка CMake при конфигурации, сообщающая, что размер RAM в `.ld` файле больше ожидаемого, ИЛИ микроконтроллер уходит в HardFault сразу после сброса (SP указывает на несуществующую память).
*   **Причина:** Используется `linker_script: "auto"`, но сумма `heap_size` + `stack_size` или значения по умолчанию в шаблоне превышают физическую RAM чипа. Либо выбран неверный MCU.
*   **Решение:**
    1.  Проверьте поле `mcu` в `stm32_config.yml` (правильный ли part number?).
    2.  Проверьте `heap_size` и `stack_size`.
    3.  Если используется кастомный `.ld` файл, проверьте параметр `LENGTH` в секции `MEMORY`.

### 2. "Undefined reference to Reset_Handler"
*   **Симптом:** Ошибка линкера.
*   **Причина:** Стартап-файл (`startup_stm32....s`) не попал в сборку.
*   **Решение:**
    *   Убедитесь, что `use_cmsis: true` в `stm32_config.yml`.
    *   Если `use_cmsis: false`, вы ОБЯЗАНЫ вручную добавить путь к стартап-файлу в список `sources`.
    *   Если вы переопределили `system_*.c` в `sources`, но забыли про стартап-файл, автоматика могла отключиться.

### 3. "fatal error: stm32..._hal_conf.h: No such file"
*   **Причина:** Файл конфигурации HAL не найден в путях поиска (include paths).
*   **Решение:** Убедитесь, что папка, содержащая `stm32f4xx_hal_conf.h` (обычно это `Core/Inc` или корень `.`), добавлена в список `include_directories` в `stm32_config.yml`.

### 4. "Syntax error in cmake code ... FindFreeRTOS.cmake"
*   **Причина:** Пути в Windows с обратными слэшами (`\`) в переменной окружения `CMAKE_USER_HOME`.
*   **Решение:** Фреймворк должен обрабатывать это автоматически, но если вы задаете пути вручную, используйте прямые слэши `/`.

## Инструменты отладки сборки

В `stm32_config.yml` можно включить подробное логирование для диагностики:

```yaml
# Показать полные команды компилятора в консоли (проверить флаги -mfloat-abi и т.д.)
verbose_build: true

# Показать в логе CMake, какие свойства (includes, defines) были применены к цели
log_target_properties: true
```
